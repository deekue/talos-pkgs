name: ipxe
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  - stage: liblzma
steps:
  - sources:
      - url: https://github.com/ipxe/ipxe/archive/c5af41a6f5b5f4a420b3e539f9e3a8dc9f8dd03e.tar.gz
        destination: ipxe.tar.gz
        sha256: 370ef608f6314fe53bef52f780288364aa446428eb774c1cd55c656b81fe23b8
        sha512: 4aa202b8b9489b217c8ef66b8cb3a8179689e98f2807024246d022eadc311f842855d19f20430bdbeb2358aca6ee7c9533d3f60456ba3b1681a8a22f31c2aa50
    env:
      IPXE_VERSION: 1.21.1+git+c5af41a+sidero
    prepare:
      - |
        ln -s /toolchain/bin/echo /bin/echo
        tar -xzf ipxe.tar.gz --strip-components=1

        patch -p1 < /pkg/patches/https.patch
        # TODO: remove once ipxe release compiles file on gcc-12
        patch -p3 < /pkg/patches/silence-gcc-12-spurious-warnings.patch

        # ref: https://github.com/siderolabs/sidero/issues/806
        {{ if eq .ARCH "aarch64" }}
        cat <<EOF > src/config/local/nap.h
        #undef NAP_EFIARM
        #define NAP_NULL
        EOF
        {{ end }}
    build:
      - |
        cd src/

        {{ if eq .ARCH "aarch64" }}
        ARCH= make -j $(nproc) bin-arm64-efi/ipxe.efi EMBED=/pkg/files/ipxe.script VERSION=${IPXE_VERSION}
        gcc ./util/zbin.c -llzma -o util/zbin
        {{ else }}
        ARCH= make -j $(nproc) bin/undionly.kpxe bin-x86_64-efi/ipxe.efi EMBED=/pkg/files/ipxe.script VERSION=${IPXE_VERSION}
        ARCH= make bin/undionly.kpxe.bin bin/undionly.kpxe.zinfo EMBED=/pkg/files/ipxe.script VERSION=${IPXE_VERSION}
        {{ end }}
    install:
      - |
        cd src/

        mkdir -p /rootfs/{usr/libexec,usr/libexec/kpxe}

        {{ if eq .ARCH "aarch64" }}
        cp -p bin-arm64-efi/ipxe.efi /rootfs/usr/libexec
        {{ else }}
        cp -p bin/undionly.kpxe bin-x86_64-efi/ipxe.efi /rootfs/usr/libexec
        cp -p bin/undionly.kpxe.bin bin/undionly.kpxe.zinfo /rootfs/usr/libexec/kpxe
        {{ end }}
        cp -p util/zbin /rootfs/usr/libexec
finalize:
  - from: /rootfs
    to: /
# Generating .kpxe via zbin:
#   [ZBIN] bin/undionly.kpxe.zbin
#    ./util/zbin bin/undionly.kpxe.bin bin/undionly.kpxe.zinfo > bin/undionly.kpxe.zbin
#  [FINISH] bin/undionly.kpxe
#    cp bin/undionly.kpxe.zbin bin/undionly.kpxe
